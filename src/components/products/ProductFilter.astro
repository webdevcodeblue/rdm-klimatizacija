---
// ProductFilter komponenta za filtriranje proizvoda
export interface Props {
  manufacturers?: string[];
  categoryType?: 'climate' | 'microclimate'; // Tip kategorije za prilagodbu filtera
  currentFilters?: {
    manufacturers?: string[]; // Changed to array for multiple selection
    power?: string;
    area?: string;
    airflow?: string; // Za mikroklima
    priceMin?: number;
    priceMax?: number;
  };
}

const { manufacturers = [], categoryType = 'climate', currentFilters = {} } = Astro.props;

// Opcije za filtriranje - SNAGA (za Climate kategorije)
const powerOptions = [
  { value: '2-2.5', label: '2.0 - 2.5 kW' },
  { value: '2.5-3.5', label: '2.5 - 3.5 kW' },
  { value: '3.5-5', label: '3.5 - 5.0 kW' },
  { value: '5-7', label: '5.0 - 7.0 kW' },
  { value: '7-10', label: '7.0 - 10.0 kW' },
  { value: '10+', label: '10.0+ kW' }
];

// Opcije za filtriranje - PROSTOR
const areaOptions = [
  { value: '0-20', label: 'do 20 m²' },
  { value: '20-30', label: '20 - 30 m²' },
  { value: '30-40', label: '30 - 40 m²' },
  { value: '40-60', label: '40 - 60 m²' },
  { value: '60-80', label: '60 - 80 m²' },
  { value: '80+', label: '80+ m²' }
];

// Opcije za filtriranje - PROTOK ZRAKA (za Mikroklima)
const airflowOptions = [
  { value: '0-200', label: 'do 200 m³/h' },
  { value: '200-400', label: '200 - 400 m³/h' },
  { value: '400-600', label: '400 - 600 m³/h' },
  { value: '600-800', label: '600 - 800 m³/h' },
  { value: '800-1000', label: '800 - 1000 m³/h' },
  { value: '1000-2000', label: '1000 - 2000 m³/h' },
  { value: '2000+', label: '2000+ m³/h' }
];
---

<aside class="product-filter" id="productFilter">
  <div class="filter__header">
    <h3 class="filter__title">Filtriraj proizvode</h3>
    <button class="filter__clear" id="clearFilters" type="button">
      Očisti filtere
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <form class="filter__form" id="filterForm">
    <!-- FILTER 1: Proizvođač (za sve kategorije) -->
    {manufacturers.length > 0 && (
      <div class="filter__group">
        <h4 class="filter__group-title">Proizvođač</h4>
        <div class="filter__options filter__options--scroll">
          {manufacturers.map((manufacturer) => (
            <label class="filter__checkbox">
              <input
                type="checkbox"
                name="manufacturer"
                value={manufacturer}
                checked={currentFilters.manufacturers?.includes(manufacturer)}
              />
              <span class="filter__checkbox-label">{manufacturer}</span>
            </label>
          ))}
        </div>
      </div>
    )}

    <!-- FILTER 2: Snaga (samo za Climate kategorije: klima uređaji, multi klima, dizalice topline) -->
    {categoryType === 'climate' && (
      <div class="filter__group">
        <h4 class="filter__group-title">Snaga hlađenja/grijanja</h4>
        <select class="filter__select" name="power">
          <option value="">Sve snage</option>
          {powerOptions.map((option) => (
            <option value={option.value} selected={currentFilters.power === option.value}>
              {option.label}
            </option>
          ))}
        </select>
      </div>
    )}

    <!-- FILTER 3: Površina (za sve kategorije) -->
    <div class="filter__group">
      <h4 class="filter__group-title">Prikladno za prostor</h4>
      <select class="filter__select" name="area">
        <option value="">Sve površine</option>
        {areaOptions.map((option) => (
          <option value={option.value} selected={currentFilters.area === option.value}>
            {option.label}
          </option>
        ))}
      </select>
    </div>

    <!-- FILTER 4: Protok zraka (samo za Mikroklima) -->
    {categoryType === 'microclimate' && (
      <div class="filter__group">
        <h4 class="filter__group-title">Protok zraka</h4>
        <div class="filter__options">
          {airflowOptions.map((option) => (
            <label class="filter__checkbox">
              <input
                type="checkbox"
                name="airflow"
                value={option.value}
                checked={currentFilters.airflow === option.value}
              />
              <span class="filter__checkbox-label">{option.label}</span>
            </label>
          ))}
        </div>
      </div>
    )}

    <!-- Raspon cijene (opcionalno) -->
    <div class="filter__group">
      <h4 class="filter__group-title">Raspon cijene (€)</h4>
      <div class="filter__range">
        <input
          type="number"
          class="filter__input"
          name="priceMin"
          placeholder="Min"
          value={currentFilters.priceMin}
          min="0"
        />
        <span class="filter__range-separator">-</span>
        <input
          type="number"
          class="filter__input"
          name="priceMax"
          placeholder="Max"
          value={currentFilters.priceMax}
          min="0"
        />
      </div>
    </div>

    <!-- Primjeni filtere -->
    <button type="submit" class="filter__submit">
      Primjeni filtere
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
    </button>
  </form>
</aside>

<!-- Mobile filter toggle -->
<button class="filter-toggle" id="filterToggle" aria-label="Toggle filters" type="button">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
  </svg>
  Filtriraj
</button>

<style>
  .product-filter {
    background: var(--color-white);
    border-radius: var(--border-radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-card);
    position: sticky;
    top: calc(var(--header-height) + var(--space-4));
    max-height: calc(100vh - var(--header-height) - var(--space-8));
    overflow-y: auto;
  }

  .filter__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-color);
  }

  .filter__title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .filter__clear {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    color: var(--color-danger);
    border: 1px solid var(--color-danger);
    border-radius: var(--border-radius-base);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter__clear:hover {
    background: var(--color-danger);
    color: var(--color-white);
  }

  .filter__form {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .filter__group {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .filter__group-title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .filter__options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .filter__options--scroll {
    max-height: 200px;
    overflow-y: auto;
    padding-right: var(--space-2);
  }

  .filter__options--scroll::-webkit-scrollbar {
    width: 4px;
  }

  .filter__options--scroll::-webkit-scrollbar-track {
    background: var(--color-gray-100);
    border-radius: var(--border-radius-full);
  }

  .filter__options--scroll::-webkit-scrollbar-thumb {
    background: var(--color-gray-400);
    border-radius: var(--border-radius-full);
  }

  .filter__checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--border-radius-base);
    transition: background var(--transition-fast);
  }

  .filter__checkbox:hover {
    background: var(--color-gray-50);
  }

  .filter__checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius-base);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter__checkbox input[type="checkbox"]:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
  }

  .filter__checkbox-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .filter__select {
    padding: var(--space-3);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-base);
    font-size: var(--text-sm);
    color: var(--text-primary);
    background: var(--color-white);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter__select:hover {
    border-color: var(--color-primary);
  }

  .filter__select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
  }

  .filter__range {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .filter__input {
    flex: 1;
    padding: var(--space-3);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-base);
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
  }

  .filter__input:hover {
    border-color: var(--color-primary);
  }

  .filter__input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
  }

  .filter__range-separator {
    color: var(--text-muted);
  }

  .filter__submit {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    background: var(--color-primary);
    color: var(--color-white);
    border: none;
    border-radius: var(--border-radius-lg);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter__submit:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  /* Mobile filter toggle */
  .filter-toggle {
    display: none;
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: 100;
    padding: var(--space-3) var(--space-5);
    background: var(--color-primary);
    color: var(--color-white);
    border: none;
    border-radius: var(--border-radius-full);
    box-shadow: var(--shadow-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-toggle:hover {
    background: var(--color-primary-hover);
    transform: scale(1.05);
  }

  /* Mobile styles */
  @media (max-width: 1024px) {
    .product-filter {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      max-height: 100vh;
      border-radius: 0;
      transform: translateX(-100%);
      transition: transform var(--transition-base);
    }

    .product-filter.active {
      transform: translateX(0);
    }

    .filter-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
  }
</style>

<script>
  const filterForm = document.getElementById('filterForm') as HTMLFormElement;
  const clearFilters = document.getElementById('clearFilters');
  const filterToggle = document.getElementById('filterToggle');
  const productFilter = document.getElementById('productFilter');

  // Handle filter form submission
  filterForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(filterForm);
    const params = new URLSearchParams();

    // Handle manufacturer checkboxes (multiple values allowed)
    const manufacturers = formData.getAll('manufacturer');
    manufacturers.forEach(manufacturer => {
      if (manufacturer) {
        params.append('manufacturer', manufacturer.toString());
      }
    });

    // Handle other single-value fields
    const singleFields = ['power', 'area', 'airflow', 'priceMin', 'priceMax'];
    singleFields.forEach(field => {
      const value = formData.get(field);
      if (value) {
        params.append(field, value.toString());
      }
    });

    // Update URL with filter params
    window.location.href = `${window.location.pathname}?${params.toString()}`;
  });

  // Clear all filters
  clearFilters?.addEventListener('click', () => {
    window.location.href = window.location.pathname;
  });

  // Mobile filter toggle
  filterToggle?.addEventListener('click', () => {
    productFilter?.classList.toggle('active');
    document.body.classList.toggle('filter-open');
  });

  // Close mobile filter when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (
      productFilter?.classList.contains('active') &&
      !productFilter.contains(target) &&
      !filterToggle?.contains(target)
    ) {
      productFilter.classList.remove('active');
      document.body.classList.remove('filter-open');
    }
  });
</script>
