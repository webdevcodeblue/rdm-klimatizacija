---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import ProductFilter from '../../components/products/ProductFilter.astro';
import ProductCard from '../../components/products/ProductCard.astro';
import InquiryModal from '../../components/InquiryModal.astro';
import { getCollection } from 'astro:content';

const allProducts = await getCollection('alati-materijali');

const products = allProducts.map((entry) => ({
  id: entry.slug,
  slug: entry.slug,
  name: entry.data.name,
  manufacturer: entry.data.manufacturer,
  category: 'Alati i materijali',
  price: entry.data.price,
  originalPrice: entry.data.originalPrice,
  power: undefined,
  cooling: undefined,
  heating: undefined,
  area: undefined,
  airflow: undefined,
  energyClass: undefined,
  seer: undefined,
  scop: undefined,
  features: entry.data.features,
  badge: entry.data.badge,
  image: entry.data.image,
  inStock: entry.data.inStock,
  description: entry.data.specifications?.type || entry.data.model
}));

// Get manufacturers and categories for filters
const manufacturers = [...new Set(products.map(p => p.manufacturer))].sort();
const categories = [...new Set(products.map(p => p.category))].sort();

// Get filter params from URL
const url = Astro.url;
const brandFilter = url.searchParams.get('brand');

const currentFilters = {
  manufacturers: url.searchParams.getAll('manufacturer'), // Multiple manufacturers
  category: url.searchParams.get('category') || undefined,
  power: url.searchParams.get('power') || undefined,
  area: url.searchParams.get('area') || undefined,
  energyClass: url.searchParams.get('energyClass') || undefined,
  priceMin: url.searchParams.get('priceMin') ? Number(url.searchParams.get('priceMin')) : undefined,
  priceMax: url.searchParams.get('priceMax') ? Number(url.searchParams.get('priceMax')) : undefined
};

// Filter products based on current filters
let filteredProducts = products;

// Filter by brand from navigation dropdown
if (brandFilter) {
  filteredProducts = filteredProducts.filter(p => {
    const matches = p.manufacturer?.toLowerCase() === brandFilter.toLowerCase();
    return matches;
  });
}

// Filter by manufacturers from sidebar (multiple selection)
if (currentFilters.manufacturers && currentFilters.manufacturers.length > 0) {
  filteredProducts = filteredProducts.filter(p =>
    currentFilters.manufacturers.includes(p.manufacturer)
  );
}

// Sort products by price (lowest to highest)
// Use current price (either discounted price or regular price)
filteredProducts.sort((a, b) => {
  const priceA = a.price || 0; // Use current price, default to 0 if no price
  const priceB = b.price || 0;
  return priceA - priceB; // Ascending order (lowest to highest)
});

const viewMode = url.searchParams.get('view') || 'list';
---

<BaseLayout
  title="Alati i materijali za klima uređaje"
  description="Pregledajte našu ponudu alata i materijala - daljinski upravljači, ventili, priključci i instalacijski materijal"
  keywords="daljinski upravljači, ventili, priključci, instalacijski materijal, alati za klime"
>
  <Header />

  <main class="products-page">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <div class="container">
        <nav aria-label="Breadcrumb">
          <ol class="breadcrumb__list">
            <li class="breadcrumb__item">
              <a href="/">Početna</a>
            </li>
            <li class="breadcrumb__item active">
              Alati i materijali
            </li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Page Header -->
    <section class="page-header">
      <div class="container">
        <h1 class="page-header__title">Alati i materijali</h1>
        <p class="page-header__description">
          Daljinski upravljači, ventili, priključci i instalacijski materijal za klima uređaje
        </p>
      </div>
    </section>

    <!-- Products Section -->
    <section class="products-section">
      <div class="container">
        <div class="products-layout">
          <!-- Sidebar - Product List -->
          <aside class="products-sidebar">
            <div class="product-list-sidebar">
              <h3 class="product-list-sidebar__title">Svi proizvodi</h3>
              <ul class="product-list-sidebar__list">
                {products.map((product) => (
                  <li class="product-list-sidebar__item">
                    <a href={`#product-${product.id}`} class="product-list-sidebar__link">
                      {product.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </aside>

          <!-- Main Content -->
          <div class="products-main">
            <!-- Toolbar -->
            <div class="products-toolbar">
              <div class="products-toolbar__info">
                <span class="products-count">
                  Prikazano <strong>{filteredProducts.length}</strong> proizvoda
                </span>
              </div>

              <div class="products-toolbar__controls">
                <div class="view-switcher">
                  <button
                    class={`view-switcher__btn ${viewMode === 'grid' ? 'active' : ''}`}
                    data-view="grid"
                    aria-label="Grid view"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"></rect>
                      <rect x="14" y="3" width="7" height="7"></rect>
                      <rect x="14" y="14" width="7" height="7"></rect>
                      <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                  </button>
                  <button
                    class={`view-switcher__btn ${viewMode === 'list' ? 'active' : ''}`}
                    data-view="list"
                    aria-label="List view"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Products Grid/List -->
            <div class={`products-grid products-grid--${viewMode}`}>
              {filteredProducts.map((product) => (
                <div id={`product-${product.id}`}>
                  <ProductCard product={product} viewMode={viewMode} />
                </div>
              ))}
            </div>

            <!-- Pagination -->
            <div class="pagination">
              <button class="pagination__btn pagination__btn--prev" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Prethodna
              </button>

              <div class="pagination__pages">
                <button class="pagination__page active">1</button>
                <button class="pagination__page">2</button>
                <button class="pagination__page">3</button>
                <span class="pagination__ellipsis">...</span>
                <button class="pagination__page">10</button>
              </div>

              <button class="pagination__btn pagination__btn--next">
                Sljedeća
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="container">
        <div class="cta">
          <div class="cta__content">
            <h2 class="cta__title">Ne možete pronaći što tražite?</h2>
            <p class="cta__description">
              Kontaktirajte nas i pomoći ćemo vam odabrati idealan alat ili materijal za vaše potrebe
            </p>
          </div>
          <div class="cta__actions">
            <a href="/kontakt" class="btn btn--primary btn--large">
              Kontaktirajte nas
            </a>
            <a href="tel:+385991234567" class="btn btn--secondary btn--large">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              099 123 4567
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
  <InquiryModal />
</BaseLayout>

<style>
  /* Breadcrumb */
  .breadcrumb {
    background: var(--color-gray-50);
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--border-color);
  }

  .breadcrumb__list {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .breadcrumb__item {
    font-size: var(--text-sm);
  }

  .breadcrumb__item a {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .breadcrumb__item a:hover {
    color: var(--color-primary);
  }

  .breadcrumb__item.active {
    color: var(--text-primary);
    font-weight: var(--font-medium);
  }

  .breadcrumb__item:not(:last-child)::after {
    content: '/';
    margin: 0 var(--space-2);
    color: var(--text-muted);
  }

  /* Page Header */
  .page-header {
    padding: var(--space-12) 0;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: var(--color-white);
    text-align: center;
  }

  .page-header__title {
    font-size: var(--text-5xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-4);
  }

  .page-header__description {
    font-size: var(--text-xl);
    opacity: 0.95;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Products Section */
  .products-section {
    padding: var(--space-16) 0;
    background: var(--bg-secondary);
  }

  .products-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--space-8);
  }

  .products-sidebar {
    position: sticky;
    top: 20px;
    align-self: start;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }

  .products-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .products-sidebar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .products-sidebar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .products-sidebar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Product List Sidebar */
  .product-list-sidebar {
    background: var(--color-white);
    border-radius: var(--border-radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-card);
  }

  .product-list-sidebar__title {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 2px solid var(--color-primary);
  }

  .product-list-sidebar__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .product-list-sidebar__item {
    margin: 0;
  }

  .product-list-sidebar__link {
    display: block;
    padding: var(--space-3) var(--space-4);
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-base);
    transition: all var(--transition-fast);
    font-size: var(--text-sm);
    line-height: 1.4;
  }

  .product-list-sidebar__link:hover {
    background: var(--color-primary-light);
    color: var(--color-primary);
    transform: translateX(4px);
  }

  /* Toolbar */
  .products-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: var(--color-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .products-count {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .products-count strong {
    color: var(--text-primary);
    font-weight: var(--font-semibold);
  }

  .products-toolbar__controls {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .view-switcher {
    display: flex;
    gap: var(--space-1);
    padding: var(--space-1);
    background: var(--color-gray-100);
    border-radius: var(--border-radius-base);
  }

  .view-switcher__btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--border-radius-base);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .view-switcher__btn:hover {
    background: var(--color-white);
    color: var(--text-primary);
  }

  .view-switcher__btn.active {
    background: var(--color-white);
    color: var(--color-primary);
    box-shadow: var(--shadow-sm);
  }

  /* Products Grid */
  .products-grid {
    display: grid;
    gap: var(--space-6);
    margin-bottom: var(--space-12);
  }

  .products-grid--grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }

  .products-grid--list {
    grid-template-columns: 1fr;
  }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
  }

  .pagination__btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--color-white);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .pagination__btn:hover:not(:disabled) {
    background: var(--color-primary);
    color: var(--color-white);
    border-color: var(--color-primary);
  }

  .pagination__btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination__pages {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .pagination__page {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-white);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-base);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .pagination__page:hover {
    background: var(--color-gray-50);
  }

  .pagination__page.active {
    background: var(--color-primary);
    color: var(--color-white);
    border-color: var(--color-primary);
  }

  .pagination__ellipsis {
    color: var(--text-muted);
  }

  /* CTA Section */
  .cta-section {
    padding: var(--space-16) 0;
    background: var(--color-white);
  }

  .cta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-12);
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: var(--border-radius-2xl);
    color: var(--color-white);
  }

  .cta__title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-2);
  }

  .cta__description {
    font-size: var(--text-lg);
    opacity: 0.95;
  }

  .cta__actions {
    display: flex;
    gap: var(--space-4);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    border: none;
    border-radius: var(--border-radius-lg);
    font-weight: var(--font-semibold);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .btn--primary {
    background: var(--color-white);
    color: var(--color-primary);
  }

  .btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .btn--secondary {
    background: transparent;
    color: var(--color-white);
    border: 2px solid var(--color-white);
  }

  .btn--secondary:hover {
    background: var(--color-white);
    color: var(--color-primary);
  }

  .btn--large {
    padding: var(--space-4) var(--space-8);
    font-size: var(--text-lg);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .products-layout {
      grid-template-columns: 1fr;
    }

    .products-sidebar {
      display: none;
      position: static;
      max-height: none;
      overflow: visible;
    }

    .page-header {
      padding: var(--space-10) 0;
    }

    .page-header__title {
      font-size: var(--text-4xl);
    }

    .products-section {
      padding: var(--space-12) 0;
    }

    .cta {
      flex-direction: column;
      text-align: center;
      gap: var(--space-8);
      padding: var(--space-8);
    }

    .cta__title {
      font-size: var(--text-2xl);
    }
  }

  @media (max-width: 768px) {
    .breadcrumb {
      padding: var(--space-2) 0;
    }

    .breadcrumb__item {
      font-size: var(--text-xs);
    }

    .page-header {
      padding: var(--space-8) 0;
    }

    .page-header__title {
      font-size: var(--text-3xl);
      padding: 0 var(--space-4);
    }

    .page-header__description {
      font-size: var(--text-base);
      padding: 0 var(--space-4);
    }

    .products-section {
      padding: var(--space-8) 0;
    }

    .products-toolbar {
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-3);
    }

    .products-count {
      text-align: center;
    }

    .products-toolbar__controls {
      width: 100%;
      justify-content: center;
    }

    .view-switcher {
      display: none;
    }

    .products-grid {
      gap: var(--space-3);
    }

    .products-grid--grid {
      grid-template-columns: 1fr;
    }

    .pagination {
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .pagination__btn {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
    }

    .pagination__pages {
      order: 3;
      width: 100%;
      justify-content: center;
      margin-top: var(--space-3);
    }

    .pagination__page {
      width: 36px;
      height: 36px;
      font-size: var(--text-sm);
    }

    .cta-section {
      padding: var(--space-8) 0;
    }

    .cta {
      padding: var(--space-6);
      border-radius: var(--border-radius-xl);
    }

    .cta__title {
      font-size: var(--text-xl);
    }

    .cta__description {
      font-size: var(--text-base);
    }

    .cta__actions {
      flex-direction: column;
      width: 100%;
    }

    .btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-header__title {
      font-size: var(--text-2xl);
    }

    .page-header__description {
      font-size: var(--text-sm);
    }

    .products-toolbar {
      padding: var(--space-2);
    }

    .cta {
      padding: var(--space-4);
    }

    .cta__title {
      font-size: var(--text-lg);
    }

    .cta__description {
      font-size: var(--text-sm);
    }

    .btn--large {
      padding: var(--space-3) var(--space-6);
      font-size: var(--text-base);
    }
  }
</style>

<script>
  // View switcher
  document.querySelectorAll('.view-switcher__btn').forEach(button => {
    button.addEventListener('click', () => {
      const view = button.dataset.view;
      const url = new URL(window.location.href);
      url.searchParams.set('view', view);
      window.location.href = url.toString();
    });
  });
</script>
