---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import { getCollection } from 'astro:content';

const query = Astro.url.searchParams.get('q')?.toLowerCase().trim() || '';

let results: any[] = [];
let totalResults = 0;

if (query && query.length >= 2) {
  // Dohvati sve proizvode iz svih kategorija
  const [
    klimaUredaji,
    multiKlima,
    dizaliceTopline,
    mikroklima,
    alatiMaterijal,
    montazaServis
  ] = await Promise.all([
    getCollection('klima-uredaji'),
    getCollection('multi-klima'),
    getCollection('dizalice-topline'),
    getCollection('mikroklima'),
    getCollection('alati-materijali'),
    getCollection('montaza-servis')
  ]);

  // Kombiniraj sve proizvode sa info o kategoriji
  const allProducts = [
    ...klimaUredaji.map(p => ({ ...p, category: 'klima-uredaji', categoryName: 'Klima uređaji' })),
    ...multiKlima.map(p => ({ ...p, category: 'multi-klima', categoryName: 'Multi klima' })),
    ...dizaliceTopline.map(p => ({ ...p, category: 'dizalice-topline', categoryName: 'Dizalice topline' })),
    ...mikroklima.map(p => ({ ...p, category: 'mikroklima', categoryName: 'Mikroklima' })),
    ...alatiMaterijal.map(p => ({ ...p, category: 'alati-materijali', categoryName: 'Alati i materijal' })),
    ...montazaServis.map(p => ({ ...p, category: 'montaza-servis', categoryName: 'Montaža i servis' }))
  ];

  // Pretraži proizvode
  results = allProducts.filter(product => {
    // Normaliziraj tekst - zamijeni specijalne znakove sa latiničnim ekvivalentima
    const normalize = (text: string) => {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Ukloni dijakritike
        .replace(/[č]/g, 'c')
        .replace(/[ć]/g, 'c')
        .replace(/[đ]/g, 'd')
        .replace(/[š]/g, 's')
        .replace(/[ž]/g, 'z')
        .replace(/[-_]/g, ' '); // Zamijeni crtice i underscore sa razmakom
    };

    const searchableText = normalize([
      product.data.name,
      product.data.manufacturer,
      product.data.model,
      product.data.description,
      product.categoryName,
      product.category, // Dodaj i slug kategorije
      product.data.features?.join(' '), // Dodaj značajke
      product.data.specifications?.type // Dodaj tip proizvoda (za alate i materijale)
    ]
      .filter(Boolean)
      .join(' '));

    const normalizedQuery = normalize(query);

    // Split query na riječi i provjeri da li sve riječi postoje u proizvodu
    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length > 0);

    return queryWords.every(word => searchableText.includes(word));
  });

  totalResults = results.length;
}

const pageTitle = query ? `Rezultati pretrage: "${query}"` : 'Pretraga proizvoda';
const pageDescription = query
  ? `Pronađeno ${totalResults} proizvoda za upit "${query}"`
  : 'Pretražite našu ponudu klima uređaja, dizalica topline i opreme';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Header />

  <main class="search-page">
    <div class="container">
      <!-- Search header -->
      <div class="search-page__header">
        <h1 class="search-page__title">
          {query ? `Rezultati pretrage: "${query}"` : 'Pretraga proizvoda'}
        </h1>
        {query && (
          <p class="search-page__subtitle">
            {totalResults === 0
              ? 'Nema pronađenih proizvoda'
              : `Pronađeno ${totalResults} ${totalResults === 1 ? 'proizvod' : totalResults < 5 ? 'proizvoda' : 'proizvoda'}`
            }
          </p>
        )}
      </div>

      {!query ? (
        <div class="search-page__empty">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <h2>Započnite pretragu</h2>
          <p>Unesite naziv proizvoda, brenda ili modela u polje za pretragu</p>
        </div>
      ) : totalResults === 0 ? (
        <div class="search-page__empty">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <h2>Nema rezultata</h2>
          <p>Pokušajte s drugim pojmom ili provjerite pravopis</p>
          <a href="/" class="btn-primary">Povratak na početnu</a>
        </div>
      ) : (
        <div class="search-results">
          {results.map((product) => (
            <a href={`/${product.category}/${product.slug}`} class="product-card">
              <div class="product-card__badge-container">
                <span class="product-card__category">{product.categoryName}</span>
                {product.data.badge && (
                  <span class={`product-card__badge product-card__badge--${product.data.badge.type}`}>
                    {product.data.badge.text}
                  </span>
                )}
              </div>

              <div class="product-card__image">
                <img
                  src={product.data.images?.[0] || product.data.image || '/images/placeholder.jpg'}
                  alt={product.data.name}
                  loading="lazy"
                />
              </div>

              <div class="product-card__content">
                <h3 class="product-card__title">{product.data.name}</h3>

                {product.data.specifications && (
                  <ul class="product-card__specs">
                    {product.data.specifications.cooling && (
                      <li>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M12 2v20M2 12h20M6 6l12 12M18 6L6 18"/>
                        </svg>
                        Hlađenje: {product.data.specifications.cooling}
                      </li>
                    )}
                    {product.data.specifications.heating && (
                      <li>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="5"/>
                          <line x1="12" y1="1" x2="12" y2="3"/>
                          <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                        Grijanje: {product.data.specifications.heating}
                      </li>
                    )}
                    {product.data.specifications.energyClass && (
                      <li>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                        Klasa: {product.data.specifications.energyClass}
                      </li>
                    )}
                  </ul>
                )}

                <div class="product-card__footer">
                  <div class="product-card__price">
                    {product.data.price ? (
                      product.data.salePrice && product.data.salePrice < product.data.price ? (
                        <>
                          <span class="product-card__price--old">{product.data.price.toFixed(2)}€</span>
                          <span class="product-card__price--sale">{product.data.salePrice.toFixed(2)}€</span>
                        </>
                      ) : (
                        <span class="product-card__price--regular">{product.data.price.toFixed(2)}€</span>
                      )
                    ) : (
                      <span class="product-card__price--regular">Na upit</span>
                    )}
                  </div>

                  <button class="product-card__button">
                    Detalji
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                      <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                  </button>
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .search-page {
    padding: var(--space-16) 0;
    min-height: 60vh;
  }

  .search-page__header {
    text-align: center;
    margin-bottom: var(--space-12);
  }

  .search-page__title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-4);
  }

  .search-page__subtitle {
    font-size: var(--text-xl);
    color: var(--text-secondary);
  }

  .search-page__empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-20) var(--space-4);
    text-align: center;
  }

  .search-page__empty svg {
    color: var(--text-muted);
    margin-bottom: var(--space-6);
  }

  .search-page__empty h2 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
  }

  .search-page__empty p {
    font-size: var(--text-lg);
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
    max-width: 500px;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    background: var(--color-primary);
    color: var(--color-white);
    font-weight: var(--font-semibold);
    border-radius: var(--border-radius-lg);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .btn-primary:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  /* Search Results Grid */
  .search-results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-6);
  }

  .product-card {
    display: flex;
    flex-direction: column;
    position: relative;
    background: var(--color-white);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-xl);
    overflow: hidden;
    transition: all var(--transition-base);
    text-decoration: none;
    height: 100%;
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-primary);
  }

  .product-card__badge-container {
    position: absolute;
    top: var(--space-3);
    left: var(--space-3);
    right: var(--space-3);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    z-index: 10;
    gap: var(--space-2);
  }

  .product-card__category {
    padding: var(--space-1) var(--space-2);
    background: rgba(255, 255, 255, 0.95);
    color: var(--text-secondary);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-sm);
  }

  .product-card__badge {
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-sm);
  }

  .product-card__badge--sale {
    background: var(--color-secondary);
    color: var(--color-white);
  }

  .product-card__badge--new {
    background: var(--color-success);
    color: var(--color-white);
  }

  .product-card__image {
    position: relative;
    aspect-ratio: 4/3;
    background: var(--color-gray-50);
    overflow: hidden;
  }

  .product-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .product-card:hover .product-card__image img {
    transform: scale(1.05);
  }

  .product-card__content {
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .product-card__title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
    line-height: var(--leading-snug);
  }

  .product-card__specs {
    list-style: none;
    padding: 0;
    margin: 0 0 var(--space-4) 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    flex-grow: 1;
  }

  .product-card__specs li {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .product-card__specs svg {
    flex-shrink: 0;
    color: var(--color-primary);
  }

  .product-card__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-color);
    margin-top: auto;
  }

  .product-card__price {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .product-card__price--old {
    font-size: var(--text-sm);
    color: var(--text-muted);
    text-decoration: line-through;
  }

  .product-card__price--sale {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-secondary);
  }

  .product-card__price--regular {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-primary);
  }

  .product-card__button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--color-primary);
    color: var(--color-white);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border: none;
    border-radius: var(--border-radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .product-card:hover .product-card__button {
    background: var(--color-primary-hover);
    gap: var(--space-3);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .search-page {
      padding: var(--space-12) 0;
    }

    .search-page__title {
      font-size: var(--text-2xl);
    }

    .search-page__subtitle {
      font-size: var(--text-lg);
    }

    .search-results {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: var(--space-4);
    }
  }

  @media (max-width: 480px) {
    .search-results {
      grid-template-columns: 1fr;
    }
  }
</style>
