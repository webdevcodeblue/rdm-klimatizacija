---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import ProductFilter from '../../components/products/ProductFilter.astro';
import ProductCard from '../../components/products/ProductCard.astro';
import InquiryModal from '../../components/InquiryModal.astro';

// Import all product categories
import { klimaProducts } from '../../data/products/klima-uredaji';
import { multiProducts } from '../../data/products/multi-klima';
import { dizaliceProducts } from '../../data/products/dizalice-topline';
import { mikroklimaProducts } from '../../data/products/mikroklima';
import { alatProducts } from '../../data/products/alati-materijali';

// Collect all products with "Akcija" badge from all categories
// Use optional chaining and default empty arrays to handle undefined imports
const allProducts = [
  ...(klimaProducts || []).map(p => ({ ...p, categoryName: 'Klima uređaji', categoryPath: '/klima-uredaji' })),
  ...(multiProducts || []).map(p => ({ ...p, categoryName: 'Multi klima', categoryPath: '/multi-klima' })),
  ...(dizaliceProducts || []).map(p => ({ ...p, categoryName: 'Dizalice topline', categoryPath: '/dizalice-topline' })),
  ...(mikroklimaProducts || []).map(p => ({ ...p, categoryName: 'Mikroklima', categoryPath: '/mikroklima' })),
  ...(alatProducts || []).map(p => ({ ...p, categoryName: 'Alati i materijali', categoryPath: '/alati-materijali' }))
];

// Filter only products with "Akcija" badge
const akcijeProducts = allProducts.filter(p => p.badge && p.badge.toLowerCase() === 'akcija');

// Convert to ProductCard format
const products = akcijeProducts.map(p => ({
  id: p.id,
  slug: p.slug,
  name: p.name,
  manufacturer: p.manufacturer,
  category: p.categoryName,
  price: p.price,
  originalPrice: p.originalPrice,
  power: p.specifications?.power || p.power || `${p.specifications?.cooling || ''} / ${p.specifications?.heating || ''}`,
  cooling: p.specifications?.cooling || p.specifications?.coolingCapacity || '',
  heating: p.specifications?.heating || p.specifications?.heatingCapacity || '',
  area: p.specifications?.area || p.area || '',
  airflow: p.specifications?.airflow || '',
  energyClass: p.specifications?.energyClass || p.energyClass || '',
  seer: p.specifications?.seer,
  scop: p.specifications?.scop,
  features: p.features || [],
  badge: p.badge,
  image: p.image,
  inStock: p.inStock,
  href: `${p.categoryPath}/${p.slug}`,
  description: p.description || p.model || ''
}));

// Get categories for filters
const categories = [...new Set(products.map(p => p.category))].sort();
const manufacturers = [...new Set(products.map(p => p.manufacturer).filter(Boolean))].sort();

// Get filter params from URL
const url = Astro.url;

const currentFilters = {
  manufacturer: url.searchParams.get('manufacturer') || undefined,
  category: url.searchParams.get('category') || undefined,
  power: url.searchParams.get('power') || undefined,
  area: url.searchParams.get('area') || undefined,
  energyClass: url.searchParams.get('energyClass') || undefined,
  priceMin: url.searchParams.get('priceMin') ? Number(url.searchParams.get('priceMin')) : undefined,
  priceMax: url.searchParams.get('priceMax') ? Number(url.searchParams.get('priceMax')) : undefined
};

// Filter products based on current filters
let filteredProducts = products;

if (currentFilters.manufacturer) {
  filteredProducts = filteredProducts.filter(p => p.manufacturer === currentFilters.manufacturer);
}

if (currentFilters.category) {
  filteredProducts = filteredProducts.filter(p => p.category === currentFilters.category);
}

if (currentFilters.priceMin !== undefined) {
  filteredProducts = filteredProducts.filter(p => p.price >= currentFilters.priceMin!);
}

if (currentFilters.priceMax !== undefined) {
  filteredProducts = filteredProducts.filter(p => p.price <= currentFilters.priceMax!);
}

const viewMode = url.searchParams.get('view') || 'list';
---

<BaseLayout
  title="Akcije - Sniženi klima uređaji i oprema"
  description="Trenutne akcije i popusti na klima uređaje, multi split sisteme, dizalice topline i dodatnu opremu. Iskoristite posebne ponude!"
  keywords="akcije klima uređaji, sniženje klima, popust klima, akcijska ponuda, rasprodaja klima"
>
  <Header />

  <main class="products-page">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <div class="container">
        <nav aria-label="Breadcrumb">
          <ol class="breadcrumb__list">
            <li class="breadcrumb__item">
              <a href="/">Početna</a>
            </li>
            <li class="breadcrumb__item active">
              Akcije
            </li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Page Header -->
    <section class="page-header">
      <div class="container">
        <div class="page-header__content">
          <div class="page-header__badge">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
            Ograničena ponuda
          </div>
          <h1 class="page-header__title">Akcije i popusti</h1>
          <p class="page-header__description">
            Iskoristite trenutne akcije i uštedite na vrhunskim klima uređajima i opremi.
            Sve akcije su vremenski ograničene!
          </p>
        </div>
      </div>
    </section>

    <!-- Products Section -->
    <section class="products-section">
      <div class="container">
        <div class="products-layout">
          <!-- Sidebar Filters -->
          <aside class="products-sidebar">
            <ProductFilter
              manufacturers={manufacturers}
              categories={categories}
              currentFilters={currentFilters}
            />
          </aside>

          <!-- Main Content -->
          <div class="products-main">
            <!-- Toolbar -->
            <div class="products-toolbar">
              <div class="products-toolbar__info">
                <span class="products-count">
                  Prikazano <strong>{filteredProducts.length}</strong> {filteredProducts.length === 1 ? 'proizvod' : filteredProducts.length < 5 ? 'proizvoda' : 'proizvoda'} na akciji
                </span>
              </div>

              <div class="products-toolbar__controls">
                <div class="view-switcher">
                  <button
                    class={`view-switcher__btn ${viewMode === 'grid' ? 'active' : ''}`}
                    data-view="grid"
                    aria-label="Grid view"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"></rect>
                      <rect x="14" y="3" width="7" height="7"></rect>
                      <rect x="14" y="14" width="7" height="7"></rect>
                      <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                  </button>
                  <button
                    class={`view-switcher__btn ${viewMode === 'list' ? 'active' : ''}`}
                    data-view="list"
                    aria-label="List view"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Products Grid/List -->
            {filteredProducts.length > 0 ? (
              <div class={`products-grid products-grid--${viewMode}`}>
                {filteredProducts.map((product) => (
                  <ProductCard product={product} viewMode={viewMode} />
                ))}
              </div>
            ) : (
              <div class="no-products">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
                <h3>Trenutno nema aktivnih akcija</h3>
                <p>Provjerite ponovo uskoro ili pregledajte našu kompletnu ponudu proizvoda.</p>
                <a href="/" class="btn btn--primary">
                  Pregledajte ponudu
                </a>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="container">
        <div class="cta">
          <div class="cta__content">
            <h2 class="cta__title">Želite biti obaviješteni o novim akcijama?</h2>
            <p class="cta__description">
              Pretplatite se na naš newsletter ibudite prvi koji će saznati za nove popuste i akcije
            </p>
          </div>
          <div class="cta__actions">
            <a href="/kontakt" class="btn btn--primary btn--large">
              Pretplatite se
            </a>
            <a href="tel:+385991234567" class="btn btn--secondary btn--large">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              099 123 4567
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
  <InquiryModal />
</BaseLayout>

<style>
  /* Breadcrumb */
  .breadcrumb {
    background: var(--color-gray-50);
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--border-color);
  }

  .breadcrumb__list {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .breadcrumb__item {
    font-size: var(--text-sm);
  }

  .breadcrumb__item a {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .breadcrumb__item a:hover {
    color: var(--color-primary);
  }

  .breadcrumb__item.active {
    color: var(--text-primary);
    font-weight: var(--font-medium);
  }

  .breadcrumb__item:not(:last-child)::after {
    content: '/';
    margin: 0 var(--space-2);
    color: var(--text-muted);
  }

  /* Page Header - RED GRADIENT for AKCIJE */
  .page-header {
    padding: var(--space-12) 0;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: var(--color-white);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    animation: pulse 4s ease-in-out infinite;
  }

  .page-header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -5%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    animation: pulse 5s ease-in-out infinite reverse;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }

  .page-header__content {
    position: relative;
    z-index: 1;
  }

  .page-header__badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--border-radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-4);
    backdrop-filter: blur(10px);
  }

  .page-header__badge svg {
    animation: rotate 3s linear infinite;
  }

  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .page-header__title {
    font-size: var(--text-5xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-4);
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .page-header__description {
    font-size: var(--text-xl);
    opacity: 0.95;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Products Section */
  .products-section {
    padding: var(--space-16) 0;
    background: var(--bg-secondary);
  }

  .products-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--space-8);
  }

  .products-sidebar {
    position: sticky;
    top: 20px;
    align-self: start;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }

  .products-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .products-sidebar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .products-sidebar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .products-sidebar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Toolbar */
  .products-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: var(--color-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .products-count {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .products-count strong {
    color: var(--text-primary);
    font-weight: var(--font-semibold);
  }

  .products-toolbar__controls {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .view-switcher {
    display: flex;
    gap: var(--space-1);
    padding: var(--space-1);
    background: var(--color-gray-100);
    border-radius: var(--border-radius-base);
  }

  .view-switcher__btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--border-radius-base);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .view-switcher__btn:hover {
    background: var(--color-white);
    color: var(--text-primary);
  }

  .view-switcher__btn.active {
    background: var(--color-white);
    color: var(--color-primary);
    box-shadow: var(--shadow-sm);
  }

  /* Products Grid */
  .products-grid {
    display: grid;
    gap: var(--space-6);
    margin-bottom: var(--space-12);
  }

  .products-grid--grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }

  .products-grid--list {
    grid-template-columns: 1fr;
  }

  /* No Products State */
  .no-products {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-16) var(--space-6);
    text-align: center;
    background: var(--color-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .no-products svg {
    color: var(--color-gray-300);
    margin-bottom: var(--space-6);
  }

  .no-products h3 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
  }

  .no-products p {
    font-size: var(--text-base);
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
    max-width: 400px;
  }

  /* CTA Section */
  .cta-section {
    padding: var(--space-16) 0;
    background: var(--color-white);
  }

  .cta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-12);
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: var(--border-radius-2xl);
    color: var(--color-white);
  }

  .cta__title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-2);
  }

  .cta__description {
    font-size: var(--text-lg);
    opacity: 0.95;
  }

  .cta__actions {
    display: flex;
    gap: var(--space-4);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    border: none;
    border-radius: var(--border-radius-lg);
    font-weight: var(--font-semibold);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .btn--primary {
    background: var(--color-white);
    color: #dc2626;
  }

  .btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .btn--secondary {
    background: transparent;
    color: var(--color-white);
    border: 2px solid var(--color-white);
  }

  .btn--secondary:hover {
    background: var(--color-white);
    color: #dc2626;
  }

  .btn--large {
    padding: var(--space-4) var(--space-8);
    font-size: var(--text-lg);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .products-layout {
      grid-template-columns: 1fr;
    }

    .products-sidebar {
      display: none;
      position: static;
      max-height: none;
      overflow: visible;
    }

    .page-header {
      padding: var(--space-10) 0;
    }

    .page-header__title {
      font-size: var(--text-4xl);
    }

    .products-section {
      padding: var(--space-12) 0;
    }

    .cta {
      flex-direction: column;
      text-align: center;
      gap: var(--space-8);
      padding: var(--space-8);
    }

    .cta__title {
      font-size: var(--text-2xl);
    }
  }

  @media (max-width: 768px) {
    .breadcrumb {
      padding: var(--space-2) 0;
    }

    .breadcrumb__item {
      font-size: var(--text-xs);
    }

    .page-header {
      padding: var(--space-8) 0;
    }

    .page-header__title {
      font-size: var(--text-3xl);
      padding: 0 var(--space-4);
    }

    .page-header__description {
      font-size: var(--text-base);
      padding: 0 var(--space-4);
    }

    .products-section {
      padding: var(--space-8) 0;
    }

    .products-toolbar {
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-3);
    }

    .products-count {
      text-align: center;
    }

    .products-toolbar__controls {
      width: 100%;
      justify-content: center;
    }

    .view-switcher {
      display: none;
    }

    .products-grid {
      gap: var(--space-3);
    }

    .products-grid--grid {
      grid-template-columns: 1fr;
    }

    .cta-section {
      padding: var(--space-8) 0;
    }

    .cta {
      padding: var(--space-6);
      border-radius: var(--border-radius-xl);
    }

    .cta__title {
      font-size: var(--text-xl);
    }

    .cta__description {
      font-size: var(--text-base);
    }

    .cta__actions {
      flex-direction: column;
      width: 100%;
    }

    .btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-header__title {
      font-size: var(--text-2xl);
    }

    .page-header__description {
      font-size: var(--text-sm);
    }

    .page-header__badge {
      font-size: var(--text-xs);
      padding: var(--space-1) var(--space-3);
    }

    .products-toolbar {
      padding: var(--space-2);
    }

    .cta {
      padding: var(--space-4);
    }

    .cta__title {
      font-size: var(--text-lg);
    }

    .cta__description {
      font-size: var(--text-sm);
    }

    .btn--large {
      padding: var(--space-3) var(--space-6);
      font-size: var(--text-base);
    }
  }
</style>

<script>
  // View switcher
  document.querySelectorAll('.view-switcher__btn').forEach(button => {
    button.addEventListener('click', () => {
      const view = button.dataset.view;
      const url = new URL(window.location.href);
      url.searchParams.set('view', view);
      window.location.href = url.toString();
    });
  });
</script>
